<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ğŸŒ äº¬å‚è¡Œç¨‹è¡¨</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;600;700&family=Noto+Sans+TC:wght@300;400;500&display=swap" rel="stylesheet" />
  <style>
    :root {
      --ink:      #1a1a2e;
      --paper:    #faf9f6;
      --accent:   #c0392b;
      --accent2:  #e67e22;
      --muted:    #7f8c8d;
      --border:   #e8e4dc;
      --card-bg:  #ffffff;
      --tag-sight:  #e8f4f8;
      --tag-food:   #fef9e7;
      --tag-hotel:  #eaf4ea;
      --tag-shop:   #fdf2f8;
      --tag-sight-text:  #1a6a8a;
      --tag-food-text:   #a0620a;
      --tag-hotel-text:  #2e7d32;
      --tag-shop-text:   #8e24aa;
      --tag-other:       #f0eef8;
      --tag-other-text:  #5e35b1;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: 'Noto Sans TC', sans-serif;
      background: var(--paper);
      color: var(--ink);
      min-height: 100vh;
    }

    /* â”€â”€ HEADER â”€â”€ */
    .site-header {
      background: var(--ink);
      color: #fff;
      text-align: center;
      padding: 2.5rem 1rem 2rem;
      position: relative;
      overflow: hidden;
    }
    .site-header::before {
      content: '';
      position: absolute;
      inset: 0;
      background: repeating-linear-gradient(
        45deg,
        transparent,
        transparent 40px,
        rgba(255,255,255,.03) 40px,
        rgba(255,255,255,.03) 41px
      );
    }
    .site-header h1 {
      font-family: 'Noto Serif TC', serif;
      font-size: clamp(1.6rem, 5vw, 2.4rem);
      font-weight: 700;
      letter-spacing: .08em;
      position: relative;
    }
    .site-header .subtitle {
      margin-top: .5rem;
      font-size: .9rem;
      color: rgba(255,255,255,.6);
      letter-spacing: .05em;
      position: relative;
    }

    /* â”€â”€ DAY TABS â”€â”€ */
    .tabs-wrapper {
      position: sticky;
      top: 0;
      z-index: 100;
      background: var(--card-bg);
      border-bottom: 2px solid var(--border);
      box-shadow: 0 2px 8px rgba(0,0,0,.06);
    }
    .tabs {
      display: flex;
      overflow-x: auto;
      scrollbar-width: none;
      padding: 0 1rem;
    }
    .tabs::-webkit-scrollbar { display: none; }
    .tab-btn {
      flex-shrink: 0;
      padding: .85rem 1.2rem;
      border: none;
      background: none;
      cursor: pointer;
      font-family: 'Noto Sans TC', sans-serif;
      font-size: .85rem;
      font-weight: 500;
      color: var(--muted);
      border-bottom: 3px solid transparent;
      transition: color .2s, border-color .2s;
      white-space: nowrap;
    }
    .tab-btn:hover { color: var(--ink); }
    .tab-btn.active {
      color: var(--accent);
      border-bottom-color: var(--accent);
      font-weight: 700;
    }

    /* â”€â”€ MAIN LAYOUT â”€â”€ */
    .container {
      max-width: 780px;
      margin: 0 auto;
      padding: 2rem 1rem 4rem;
    }

    /* â”€â”€ DAY SECTION â”€â”€ */
    .day-section { display: none; }
    .day-section.active { display: block; }

    .day-header {
      margin-bottom: 1.8rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid var(--border);
    }
    .day-header h2 {
      font-family: 'Noto Serif TC', serif;
      font-size: 1.5rem;
      font-weight: 700;
    }
    .day-header .day-date {
      font-size: .85rem;
      color: var(--muted);
      margin-top: .25rem;
    }

    /* â”€â”€ ITEM CARD â”€â”€ */
    .item-card {
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 1.6rem 1.8rem;
      margin-bottom: 1rem;
      transition: box-shadow .2s;
      position: relative;
    }
    .item-card:hover { box-shadow: 0 4px 20px rgba(0,0,0,.08); }

    .card-top {
      display: flex;
      align-items: center;
      gap: 1rem;
    }
    .time-col {
      flex-shrink: 0;
      text-align: center;
      min-width: 100px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      align-self: stretch;
    }
    .time-start, .time-end {
      font-size: 1.75rem;
      font-weight: 800;
      color: var(--ink);
      line-height: 1.3;
      text-align: center;
      letter-spacing: -.02em;
    }
    .time-arrow {
      font-size: 1rem;
      color: var(--muted);
      text-align: center;
      line-height: 1;
      margin: .2rem 0;
    }
    .time-divider {
      width: 2px;
      align-self: stretch;
      background: var(--border);
      flex-shrink: 0;
      margin: 0 .4rem;
      border-radius: 2px;
    }
    .card-body { flex: 1; min-width: 0; padding-right: 7rem; }

    .card-title-row {
      display: flex;
      align-items: center;
      flex-wrap: wrap;
      gap: .5rem;
      margin-bottom: .5rem;
    }
    .type-tag {
      display: inline-flex;
      align-items: center;
      gap: .25rem;
      font-size: .78rem;
      font-weight: 700;
      padding: .25rem .65rem;
      border-radius: 20px;
      white-space: nowrap;
    }
    .type-tag.sight  { background: var(--tag-sight);  color: var(--tag-sight-text); }
    .type-tag.food   { background: var(--tag-food);   color: var(--tag-food-text); }
    .type-tag.hotel  { background: var(--tag-hotel);  color: var(--tag-hotel-text); }
    .type-tag.shop   { background: var(--tag-shop);   color: var(--tag-shop-text); }
    .type-tag.other  { background: var(--tag-other);  color: var(--tag-other-text); }

    .place-link {
      font-family: 'Noto Serif TC', serif;
      font-size: 1.9rem;
      font-weight: 700;
      color: var(--ink);
      text-decoration: none;
      border-bottom: 2px solid transparent;
      transition: border-color .2s, color .2s;
      line-height: 1.35;
    }
    .place-link:hover {
      color: var(--accent);
      border-bottom-color: var(--accent);
    }
    .place-link.no-link { cursor: default; }
    .place-link.no-link:hover { color: var(--ink); border-color: transparent; }

    /* åœ°é»åç¨±åˆ— */
    .place-nav-row {
      margin-bottom: .3rem;
    }

    /* å°èˆªæŒ‰éˆ•ï¼šå³å´å‚ç›´ç½®ä¸­çµ•å°å®šä½ï¼Œæ”¾å¤§ç‰ˆ */
    .nav-btn {
      position: absolute;
      right: 1.4rem;
      top: 50%;
      transform: translateY(-50%);
      display: inline-flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: .3rem;
      padding: .9rem 1.1rem;
      border-radius: 16px;
      background: #2e7d32;
      color: #fff;
      font-size: .95rem;
      font-weight: 700;
      text-decoration: none;
      border: none;
      transition: background .2s, transform .15s, box-shadow .2s;
      white-space: nowrap;
      box-shadow: 0 3px 10px rgba(46,125,50,.35);
      min-width: 64px;
      cursor: pointer;
    }
    .nav-btn:hover {
      background: #1b5e20;
      transform: translateY(calc(-50% - 2px));
      box-shadow: 0 6px 16px rgba(46,125,50,.45);
    }
    .nav-btn svg {
      width: 26px; height: 26px;
      fill: currentColor;
    }

    /* å‚™è¨»å€å¡Š */
    .card-notes {
      margin-top: .55rem;
      display: flex;
      flex-direction: column;
      gap: .35rem;
    }
    .note-item {
      display: flex;
      gap: .45rem;
      font-size: .88rem;
      color: #555;
      line-height: 1.55;
    }
    .note-label {
      font-size: .75rem;
      font-weight: 700;
      padding: .15rem .4rem;
      border-radius: 4px;
      background: #f0f0f0;
      color: #888;
      white-space: nowrap;
      align-self: flex-start;
      margin-top: .15rem;
    }

    .card-cost {
      margin-top: .65rem;
      display: inline-flex;
      align-items: center;
      gap: .3rem;
      font-size: .88rem;
      color: var(--accent2);
      font-weight: 600;
    }

    /* â”€â”€ LOADING / ERROR â”€â”€ */
    .state-msg {
      text-align: center;
      padding: 4rem 1rem;
      color: var(--muted);
      font-size: 1rem;
    }
    .state-msg .spinner {
      width: 32px; height: 32px;
      border: 3px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin .7s linear infinite;
      margin: 0 auto 1rem;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* â”€â”€ CONFIG BANNER â”€â”€ */
    .config-banner {
      background: #fff3cd;
      border: 1px solid #ffc107;
      border-radius: 8px;
      padding: 1rem 1.2rem;
      margin-bottom: 1.5rem;
      font-size: .88rem;
      line-height: 1.7;
    }
    .config-banner strong { color: #856404; }
    .config-banner code {
      background: #f8f0d0;
      padding: .1rem .35rem;
      border-radius: 4px;
      font-size: .82rem;
    }

    /* â”€â”€ RWD â”€â”€ */
    @media (max-width: 560px) {
      .time-col { min-width: 72px; }
      .time-start, .time-end { font-size: 1.25rem; }
      .card-top { gap: .6rem; }
      .item-card { padding: 1.1rem 1rem; }
      .card-body { padding-right: 5.5rem; }
      .nav-btn { padding: .65rem .75rem; min-width: 52px; right: .9rem; }
      .nav-btn svg { width: 20px; height: 20px; }
      .nav-btn span { font-size: .8rem; }
      .place-link { font-size: 1.3rem; }
    }
  </style>
</head>
<body>

<header class="site-header">
  <h1>ğŸŒ äº¬å‚æ—…éŠè¡Œç¨‹</h1>
  <p class="subtitle" id="trip-subtitle">è¼‰å…¥ä¸­â€¦</p>
</header>

<nav class="tabs-wrapper">
  <div class="tabs" id="tabs-container"></div>
</nav>

<main class="container" id="main-content">
  <div class="state-msg" id="loading-msg">
    <div class="spinner"></div>
    æ­£åœ¨è®€å–è¡Œç¨‹è³‡æ–™â€¦
  </div>
</main>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  âš™ï¸  è¨­å®šå€ â€” åªéœ€ä¿®æ”¹é€™è£¡
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const CONFIG = {
  // 1. è²¼ä¸Šä½ çš„ Google Sheets API é‡‘é‘°
  API_KEY: 'AIzaSyDKUQWFclRLM5mBtVoXOasoYOivkxt2UdM',

  // 2. è©¦ç®—è¡¨ IDï¼ˆç¶²å€ä¸­é–“é‚£æ®µï¼‰
  SHEET_ID: '1Oxb_bl8xXXNuyTfDx8ea8CYw5zXQ5wxxS04kFf2Kapw',

  // 3. æ—…è¡Œæ¨™é¡Œ & å‰¯æ¨™
  TRIP_TITLE: 'ğŸŒ äº¬å‚æ—…éŠè¡Œç¨‹',
  TRIP_SUBTITLE: 'äº¬éƒ½ãƒ»å¤§é˜ª',
};
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// æ¬„ä½å°æ‡‰ï¼ˆA~Iï¼‰
const COL = {
  TYPE: 0,        // A é¡å‹
  TIME_START: 1,  // B æ™‚é–“(èµ·)
  TIME_END: 2,    // C æ™‚é–“(è¿„)
  PLACE: 3,       // D ç›®çš„åœ°
  MAP_URL: 4,     // E ç›®çš„åœ°(googlemap)
  COST: 5,        // F èŠ±è²»
  CURRENCY: 6,    // G å¹£åˆ¥
  NOTE1: 7,       // H å‚™è¨»
  NOTE2: 8,       // I å‚™è¨»2
};

const TYPE_META = {
  'æ™¯é»': { icon: 'ğŸ›ï¸', cls: 'sight' },
  'é¤å»³': { icon: 'ğŸœ', cls: 'food' },
  'ä½å®¿': { icon: 'ğŸ¨', cls: 'hotel' },
  'è³¼ç‰©': { icon: 'ğŸ›ï¸', cls: 'shop' },
  'å…¶ä»–': { icon: 'ğŸ“Œ', cls: 'other' },
};

// â”€â”€ å·¥å…·å‡½å¼ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function escHtml(s) {
  return String(s ?? '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

// â”€â”€ è§£æå·¥ä½œé åç¨±ï¼Œèƒå–ã€ŒDayNã€å’Œæ—¥æœŸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function parseSheetName(name) {
  // æ”¯æ´ "Day1(4/17)" æˆ– "Day1" ç­‰æ ¼å¼
  const m = name.match(/Day\s*(\d+)(?:\(([^)]+)\))?/i);
  if (!m) return null;
  return { day: parseInt(m[1]), date: m[2] || '', raw: name };
}

// â”€â”€ å–å¾—æ‰€æœ‰å·¥ä½œé åç¨± â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function fetchSheetNames() {
  const url = `https://sheets.googleapis.com/v4/spreadsheets/${CONFIG.SHEET_ID}?key=${CONFIG.API_KEY}&fields=sheets.properties.title`;
  const res = await fetch(url);
  if (!res.ok) throw new Error(`ç„¡æ³•è®€å–è©¦ç®—è¡¨ï¼š${res.status}`);
  const data = await res.json();
  return data.sheets.map(s => s.properties.title);
}

// â”€â”€ å–å¾—å–®ä¸€å·¥ä½œé è³‡æ–™ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function fetchSheet(sheetName) {
  const range = encodeURIComponent(`'${sheetName}'!A:I`);
  const url = `https://sheets.googleapis.com/v4/spreadsheets/${CONFIG.SHEET_ID}/values/${range}?key=${CONFIG.API_KEY}`;
  const res = await fetch(url);
  if (!res.ok) throw new Error(`ç„¡æ³•è®€å–å·¥ä½œé  ${sheetName}`);
  const data = await res.json();
  return data.values || [];
}

// â”€â”€ æ¸²æŸ“å–®ä¸€è¡Œç¨‹å¡ç‰‡ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderCard(row) {
  const type     = row[COL.TYPE]       || '';
  const tStart   = row[COL.TIME_START] || '';
  const tEnd     = row[COL.TIME_END]   || '';
  const place    = row[COL.PLACE]      || '';
  const mapUrl   = row[COL.MAP_URL]    || '';
  const cost     = row[COL.COST]       || '';
  const currency = row[COL.CURRENCY]   || '';
  const note1    = row[COL.NOTE1]      || '';
  const note2    = row[COL.NOTE2]      || '';

  if (!place && !type) return '';

  const meta = TYPE_META[type] || { icon: 'ğŸ“', cls: 'other' };

  // é¡å‹æ¨™ç±¤
  const tagHtml = type
    ? `<span class="type-tag ${meta.cls}">${meta.icon} ${escHtml(type)}</span>`
    : '';

  // åœ°é»åç¨±ï¼ˆå¦‚æœ‰ map URL å‰‡å¯é»æ“Šï¼‰
  const placeLinkHtml = mapUrl
    ? `<a class="place-link" href="${escHtml(mapUrl)}" target="_blank" rel="noopener">${escHtml(place)}</a>`
    : `<span class="place-link no-link">${escHtml(place)}</span>`;

  // å°èˆªæŒ‰éˆ•ï¼šå³å´å‚ç›´ç½®ä¸­ï¼Œicon ä¸Šã€æ–‡å­—ä¸‹
  const navBtnHtml = mapUrl ? `
    <a class="nav-btn" href="javascript:void(0)" onclick="navigate('${escHtml(mapUrl)}')" title="å°èˆªè‡³æ­¤åœ°é»">
      <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
        <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/>
      </svg>
      <span>å°èˆª</span>
    </a>` : '';

  // æ™‚é–“æ¬„ä½ï¼šèµ·è¿„å­—é«”ç›¸åŒï¼Œç•™ç©ºä¸é¡¯ç¤º
  const timeHtml = `
    ${tStart ? `<div class="time-start">${escHtml(tStart)}</div>` : ''}
    ${tStart && tEnd ? `<div class="time-arrow">â†“</div>` : ''}
    ${tEnd   ? `<div class="time-end">${escHtml(tEnd)}</div>` : ''}
  `;

  // å‚™è¨»ï¼šåˆ†å…©è¡Œï¼Œæ˜ç¢ºæ¨™ç¤ºå‚™è¨»1/2ï¼Œç•™ç©ºä¸é¡¯ç¤º
  let notesHtml = '';
  const noteLines = [];
  if (note1) noteLines.push(`<div class="note-item"><span class="note-label">å‚™è¨»1</span><span>${escHtml(note1)}</span></div>`);
  if (note2) noteLines.push(`<div class="note-item"><span class="note-label">å‚™è¨»2</span><span>${escHtml(note2)}</span></div>`);
  if (noteLines.length) notesHtml = `<div class="card-notes">${noteLines.join('')}</div>`;

  // èŠ±è²»
  const costHtml = cost
    ? `<div class="card-cost">ğŸ’° ${escHtml(cost)} ${escHtml(currency)}</div>`
    : '';

  return `
    <div class="item-card">
      <div class="card-top">
        <div class="time-col">${timeHtml}</div>
        <div class="time-divider"></div>
        <div class="card-body">
          <div class="card-title-row">
            ${tagHtml}
          </div>
          <div class="place-nav-row">
            ${placeLinkHtml}
            ${navBtnHtml}
          </div>
          ${notesHtml}
          ${costHtml}
        </div>
      </div>
    </div>`;
}

// â”€â”€ æ¸²æŸ“ä¸€å¤©çš„å€å¡Š â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderDay(meta, rows) {
  const id = `day-${meta.day}`;
  const cards = rows.map(renderCard).join('');
  return `
    <section class="day-section" id="${id}">
      <div class="day-header">
        <h2>Day ${meta.day}</h2>
        ${meta.date ? `<div class="day-date">ğŸ“… ${meta.date}</div>` : ''}
      </div>
      ${cards || '<p style="color:#aaa;font-size:.9rem;">æ­¤å¤©å°šç„¡è¡Œç¨‹è³‡æ–™</p>'}
    </section>`;
}

// â”€â”€ æ¸²æŸ“ Tab æŒ‰éˆ• â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderTabs(days) {
  return days.map(d =>
    `<button class="tab-btn" data-day="${d.day}" onclick="switchDay(${d.day})">
      Day ${d.day}${d.date ? '<br><small style="font-size:.7rem;opacity:.7">'+escHtml(d.date)+'</small>' : ''}
    </button>`
  ).join('');
}

// â”€â”€ åˆ‡æ› Tab â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function switchDay(n) {
  document.querySelectorAll('.day-section').forEach(s => s.classList.remove('active'));
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  const sec = document.getElementById(`day-${n}`);
  if (sec) sec.classList.add('active');
  const btn = document.querySelector(`.tab-btn[data-day="${n}"]`);
  if (btn) {
    btn.classList.add('active');
    btn.scrollIntoView({ inline: 'center', behavior: 'smooth' });
  }
}

// â”€â”€ ä¸»æµç¨‹ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function init() {
  const main = document.getElementById('main-content');
  const subtitle = document.getElementById('trip-subtitle');
  subtitle.textContent = CONFIG.TRIP_SUBTITLE;

  // å°šæœªå¡«å…¥ API é‡‘é‘°æ™‚é¡¯ç¤ºèªªæ˜
  if (CONFIG.API_KEY === 'YOUR_GOOGLE_SHEETS_API_KEY') {
    main.innerHTML = `
      <div class="config-banner">
        <strong>âš™ï¸ è¨­å®šæç¤ºï¼š</strong>è«‹é–‹å•Ÿ <code>index.html</code>ï¼Œåœ¨é ‚éƒ¨çš„ <code>CONFIG</code> å€å¡Šå¡«å…¥ä½ çš„
        <code>API_KEY</code>ï¼ˆGoogle Sheets API é‡‘é‘°ï¼‰å¾Œï¼Œé‡æ–°æ•´ç†å³å¯çœ‹åˆ°è¡Œç¨‹ã€‚<br><br>
        ç”³è«‹æ­¥é©Ÿï¼šGoogle Cloud Console â†’ å»ºç«‹å°ˆæ¡ˆ â†’ å•Ÿç”¨ Sheets API â†’ å»ºç«‹ API é‡‘é‘° â†’ è²¼åˆ° CONFIG.API_KEYã€‚
      </div>
      <div class="state-msg">ç­‰å¾… API é‡‘é‘°è¨­å®šå®Œæˆâ€¦</div>`;
    return;
  }

  try {
    const names = await fetchSheetNames();
    const daySheets = names
      .map(n => ({ ...parseSheetName(n), sheetName: n }))
      .filter(d => d !== null && d.day != null)
      .sort((a, b) => a.day - b.day);

    if (!daySheets.length) throw new Error('æ‰¾ä¸åˆ° Day é–‹é ­çš„å·¥ä½œé ');

    // ä¸¦è¡ŒæŠ“æ‰€æœ‰å·¥ä½œé 
    const allRows = await Promise.all(daySheets.map(d => fetchSheet(d.sheetName)));

    // çµ„å»º HTML
    const tabsHtml = renderTabs(daySheets);
    const sectionsHtml = daySheets.map((d, i) => {
      const rows = allRows[i].slice(1).filter(r => r.some(c => c)); // è·³éæ¨™é¡Œåˆ—ï¼Œæ¿¾ç©ºåˆ—
      return renderDay(d, rows);
    }).join('');

    document.getElementById('tabs-container').innerHTML = tabsHtml;
    main.innerHTML = sectionsHtml;

    // é è¨­é¡¯ç¤ºç¬¬ä¸€å¤©
    switchDay(daySheets[0].day);

  } catch (err) {
    main.innerHTML = `
      <div class="state-msg">
        âŒ è®€å–å¤±æ•—ï¼š${escHtml(err.message)}<br>
        <small style="margin-top:.5rem;display:block;">è«‹ç¢ºèª API é‡‘é‘°ã€è©¦ç®—è¡¨ ID æ˜¯å¦æ­£ç¢ºï¼Œä»¥åŠè©¦ç®—è¡¨å·²è¨­å®šç‚ºã€ŒçŸ¥é“é€£çµçš„ä»»ä½•äººå¯ä»¥æª¢è¦–ã€ã€‚</small>
      </div>`;
  }
}

// â”€â”€ ç”¨éš±è— <a> æ¨™ç±¤è·³è½‰ï¼ˆiOS Safari ç›¸å®¹ï¼‰â”€â”€
function openUrl(url) {
  const a = document.createElement('a');
  a.href = url;
  a.target = '_blank';
  a.rel = 'noopener';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
}

// â”€â”€ å°èˆªå‡½å¼ï¼šiOS / Android / æ¡Œé¢å…¨ç›¸å®¹ â”€â”€
function navigate(destUrl) {
  let navUrl;

  // é•·ç¶²å€å«åº§æ¨™ï¼ˆ@lat,lngï¼‰ï¼Œç›´æ¥ç”¨åº§æ¨™æœ€ç²¾æº–
  const coordMatch = destUrl.match(/@(-?\d+\.\d+),(-?\d+\.\d+)/);
  if (coordMatch) {
    // æœ‰åº§æ¨™ï¼šç”¨ saddr=ç›®å‰ä½ç½®ï¼ˆç•™ç©ºè®“ Maps è‡ªå‹•æŠ“ GPSï¼‰ï¼Œdaddr=ç›®çš„åœ°åº§æ¨™
    const dest = `${coordMatch[1]},${coordMatch[2]}`;
    navUrl = `https://maps.google.com/maps?daddr=${dest}&dirflg=d`;
  } else {
    // çŸ­ç¶²å€æˆ–ç„¡åº§æ¨™ï¼šç›´æ¥æŠŠåŸå§‹çŸ­ç¶²å€ç”¨ location æ–¹å¼è·³è½‰
    // iOS ä¸Š maps.app.goo.gl é–‹å•Ÿå¾Œæœƒè‡ªå‹•é€²å…¥åœ°é»é é¢ï¼Œå†é»å°èˆªå³å¯
    // é€™æ˜¯æœ€å¯é çš„æ–¹å¼ï¼Œä¸æœƒæœ‰åœ°é»è§£æå•é¡Œ
    navUrl = destUrl;
  }

  openUrl(navUrl);
}

init();
</script>
</body>
</html>
